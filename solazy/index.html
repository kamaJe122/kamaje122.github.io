<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§è¾¦å…¬åŠ©æ‰‹</title>
    <style>
        :root {
            --ä¸»è‰²èª¿: #FFC400;
            --è¼”åŠ©è‰²: #FFD740;
            --æ‡¸æµ®è‰²: #FFAB00;
            --éŒ¯èª¤è‰²: #D32F2F;
            --åŸºç¤å­—é«”: 14px;
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
            font-size: var(--åŸºç¤å­—é«”);
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            display: flex;
        }

        /* å´é‚Šæ¬„æ¨£å¼ */
        .å´é‚Šæ¬„ {
            width: 200px;
            background-color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 100;
            padding-top: 20px;
        }

        .å´é‚Šæ¬„æŒ‰éˆ• {
            display: block;
            width: 100%;
            padding: 15px;
            text-align: left;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .å´é‚Šæ¬„æŒ‰éˆ•.æ´»èº {
            background-color: rgba(255, 196, 0, 0.1);
            border-left-color: var(--ä¸»è‰²èª¿);
            font-weight: bold;
        }

        .å´é‚Šæ¬„æŒ‰éˆ•:hover {
            background-color: rgba(255, 196, 0, 0.1);
        }

        /* ä¸»å…§å®¹å€åŸŸ */
        .ä¸»å…§å®¹ {
            margin-left: 200px;
            width: calc(100% - 200px);
            padding: 20px;
        }

        /* é€²åº¦é¡¯ç¤ºå€åŸŸ */
        .é€²åº¦é¡¯ç¤º {
            background-color: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left: 4px solid var(--ä¸»è‰²èª¿);
        }

        .ä¸Šå‚³åœ–ç‰‡é è¦½ {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 4px;
        }

        /* åŠŸèƒ½é é¢æ¨£å¼ */
        .åŠŸèƒ½é é¢ {
            display: none;
        }

        .åŠŸèƒ½é é¢.é¡¯ç¤º {
            display: block;
        }

        /* å…±ç”¨å…ƒä»¶æ¨£å¼ */
        .ä¸»å®¹å™¨ {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid var(--ä¸»è‰²èª¿);
        }

        .æ‹–æ”¾å€ {
            border: 3px dashed var(--ä¸»è‰²èª¿);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
            background-color: rgba(255, 196, 0, 0.05);
        }

        .é€²åº¦æ¢å®¹å™¨ {
            width: 100%;
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .é€²åº¦æ¢ {
            height: 100%;
            width: 0%;
            background-color: var(--ä¸»è‰²èª¿);
            transition: width 0.3s ease-in-out;
        }

        .ä¸»è¦æŒ‰éˆ• {
            background-color: var(--ä¸»è‰²èª¿);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            min-width: 120px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            align-self: center;
        }

        .ä¸»è¦æŒ‰éˆ•:hover {
            background-color: var(--æ‡¸æµ®è‰²);
            transform: translateY(-1px);
        }

        /* åç‰‡ç³»çµ±æ¨£å¼ */
        .è¯çµ¡äººé …ç›® {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left: 4px solid var(--ä¸»è‰²èª¿);
            position: relative;
        }

        .è¯çµ¡äººå…§å®¹ {
            flex-grow: 1;
            margin-right: 20px;
        }

        .è³‡æ–™æ¬„ä½ {
            margin: 6px 0;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .æç¤ºæ–‡å­— {
            color: #888;
            font-style: italic;
        }

        .åœ–ç¤ºå€ {
            min-width: 24px;
            text-align: center;
        }

        .ç·¨è¼¯è¼¸å…¥æ¡† {
            width: 100%;
            padding: 6px;
            font-size: inherit;
            font-family: inherit;
            border: 1px solid var(--ä¸»è‰²èª¿);
            border-radius: 4px;
        }

        /* è¡Œç¨‹ç³»çµ±æ¨£å¼ */
        .æ–‡å­—è¼¸å…¥å€ {
            border: 3px dashed var(--ä¸»è‰²èª¿);
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
            background-color: rgba(255, 196, 0, 0.05);
        }

        .æ–‡å­—è¼¸å…¥å€ textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            font-size: var(--åŸºç¤å­—é«”);
            border: 1px solid var(--ä¸»è‰²èª¿);
            border-radius: 4px;
            resize: vertical;
        }

        .äº‹ä»¶é …ç›® {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left: 4px solid var(--ä¸»è‰²èª¿);
            position: relative;
        }

        .äº‹ä»¶å…§å®¹ {
            flex-grow: 1;
            margin-right: 20px;
        }

        .äº‹ä»¶æ¨™é¡Œ {
            font-weight: 700;
            font-size: calc(var(--åŸºç¤å­—é«”) + 2pt);
            color: var(--ä¸»è‰²èª¿);
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .äº‹ä»¶æ¬„ä½ {
            margin: 6px 0;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .æ¬„ä½åœ–ç¤º {
            min-width: 24px;
            text-align: center;
        }

        .æ¬¡è¦æŒ‰éˆ• {
            background-color: #fff;
            color: var(--ä¸»è‰²èª¿);
            border: 2px solid var(--ä¸»è‰²èª¿);
            padding: 6px 18px;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 10px;
        }

        .æ¬¡è¦æŒ‰éˆ•:hover {
            background-color: var(--è¼”åŠ©è‰²);
        }

        .æ™‚é–“è¼¸å…¥çµ„ {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .æ™‚é–“è¼¸å…¥ {
            width: 50px;
            padding: 4px;
        }

        @media screen and (max-width: 768px) {
            .å´é‚Šæ¬„ {
                width: 60px;
            }
            
            .å´é‚Šæ¬„æŒ‰éˆ• {
                padding: 15px 5px;
                text-align: center;
                font-size: 12px;
            }
            
            .ä¸»å…§å®¹ {
                margin-left: 60px;
                width: calc(100% - 60px);
            }
        }

        @media screen and (max-width: 430px) {
            .ä¸»å®¹å™¨ {
                padding: 15px;
                width: calc(100% - 10px);
                box-shadow: none;
                border-radius: 0;
                border: none;
            }

            .è¯çµ¡äººé …ç›®, .äº‹ä»¶é …ç›® {
                flex-direction: column;
            }

            .ä¸»è¦æŒ‰éˆ•, .æ¬¡è¦æŒ‰éˆ• {
                width: 100%;
                margin-top: 10px;
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- å´é‚Šæ¬„ -->
    <div class="å´é‚Šæ¬„">
        <button class="å´é‚Šæ¬„æŒ‰éˆ• æ´»èº" data-target="åç‰‡è¾¨è­˜ç³»çµ±">æ™ºæ…§åç‰‡è¾¨è­˜</button>
        <button class="å´é‚Šæ¬„æŒ‰éˆ•" data-target="è¡Œç¨‹ç®¡ç†ç³»çµ±">æ™ºæ…§è¡Œç¨‹ç®¡ç†</button>
        <button class="å´é‚Šæ¬„æŒ‰éˆ•" data-target="æ–°å¢åŠŸèƒ½">æ–°å¢åŠŸèƒ½</button>
    </div>

    <!-- ä¸»å…§å®¹å€åŸŸ -->
    <div class="ä¸»å…§å®¹">
        <!-- é€²åº¦é¡¯ç¤ºå€åŸŸ -->
        <div class="é€²åº¦é¡¯ç¤º" id="é€²åº¦é¡¯ç¤ºå€">
            <div id="é€²åº¦è¨Šæ¯">æº–å‚™å°±ç·’</div>
            <img id="ä¸Šå‚³åœ–ç‰‡é è¦½" class="ä¸Šå‚³åœ–ç‰‡é è¦½" style="display: none;" />
        </div>

        <!-- åç‰‡è¾¨è­˜ç³»çµ± -->
        <div class="åŠŸèƒ½é é¢ é¡¯ç¤º" id="åç‰‡è¾¨è­˜ç³»çµ±">
            <div class="ä¸»å®¹å™¨">
                <div class="æ‹–æ”¾å€" id="åç‰‡_æ‹–æ”¾å€">
                    <p>æ‹–æ”¾åç‰‡åœ–æª”è‡³æ­¤æˆ–é»æ“Šä¸Šå‚³ (æ”¯æ´ PNG/JPG)</p>
                    <input type="file" id="åç‰‡_æª”æ¡ˆè¼¸å…¥" hidden accept="image/png, image/jpeg">
                    <div class="é€²åº¦æ¢å®¹å™¨" id="åç‰‡_é€²åº¦æ¢å®¹å™¨">
                        <div class="é€²åº¦æ¢" id="åç‰‡_é€²åº¦æ¢"></div>
                    </div>
                </div>

                <div id="åç‰‡_è¯çµ¡äººæ¸…å–®"></div>

                <div class="å·¥å…·åˆ—">
                    <button class="ä¸»è¦æŒ‰éˆ•" onclick="åç‰‡_æ–°å¢è¯çµ¡äºº()">+ æ–°å¢è¯çµ¡äºº</button>
                </div>
            </div>
        </div>

        <!-- è¡Œç¨‹ç®¡ç†ç³»çµ± -->
        <div class="åŠŸèƒ½é é¢" id="è¡Œç¨‹ç®¡ç†ç³»çµ±">
            <div class="ä¸»å®¹å™¨">
                <div class="æ‹–æ”¾å€" id="è¡Œç¨‹_æ‹–æ”¾å€">
                    <p>æ‹–æ”¾åœ–ç‰‡è‡³æ­¤æˆ–é»æ“Šä¸Šå‚³ (æ”¯æ´PNG/JPG)</p>
                    <input type="file" id="è¡Œç¨‹_æª”æ¡ˆè¼¸å…¥" hidden accept="image/png, image/jpeg">
                    <div class="é€²åº¦æ¢å®¹å™¨">
                        <div class="é€²åº¦æ¢" id="è¡Œç¨‹_é€²åº¦æ¢"></div>
                    </div>
                </div>

                <div class="æ–‡å­—è¼¸å…¥å€">
                    <p>è²¼ä¸Šæ–‡å­—ä»¥è¾¨è­˜è¡Œç¨‹è³‡è¨Š</p>
                    <textarea id="è¡Œç¨‹_æ–‡å­—è¼¸å…¥" placeholder="åœ¨æ­¤è²¼ä¸Šæ–‡å­—ï¼Œä¾‹å¦‚ï¼šæœƒè­° 2025-03-15 14:00-16:00 å°åŒ—101 è²»ç”¨500å…ƒ"></textarea>
                    <button class="ä¸»è¦æŒ‰éˆ•" onclick="è¡Œç¨‹_è™•ç†æ–‡å­—è¼¸å…¥()">è¾¨è­˜æ–‡å­—</button>
                </div>

                <div id="è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨"></div>

                <div class="å·¥å…·åˆ—">
                    <button class="ä¸»è¦æŒ‰éˆ•" onclick="è¡Œç¨‹_æ–°å¢äº‹ä»¶()">+ æ–°å¢è¡Œç¨‹</button>
                </div>
            </div>
        </div>

        <!-- æ–°å¢åŠŸèƒ½ -->
        <div class="åŠŸèƒ½é é¢" id="æ–°å¢åŠŸèƒ½">
            <div class="ä¸»å®¹å™¨">
                <div style="text-align: center; padding: 40px;">
                    <h2 style="color: var(--ä¸»è‰²èª¿);">æ–°åŠŸèƒ½å³å°‡æ¨å‡º</h2>
                    <p>æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
                    <div style="margin-top: 30px;">
                        <button class="ä¸»è¦æŒ‰éˆ•" onclick="alert('åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼')">äº†è§£æ›´å¤š</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é€šç”¨åŠŸèƒ½
        // å´é‚Šæ¬„åŠŸèƒ½åˆ‡æ›
        document.querySelectorAll('.å´é‚Šæ¬„æŒ‰éˆ•').forEach(button => {
            button.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„æ´»èºç‹€æ…‹
                document.querySelectorAll('.å´é‚Šæ¬„æŒ‰éˆ•').forEach(btn => {
                    btn.classList.remove('æ´»èº');
                });
                
                // æ·»åŠ ç•¶å‰æŒ‰éˆ•çš„æ´»èºç‹€æ…‹
                this.classList.add('æ´»èº');
                
                // éš±è—æ‰€æœ‰åŠŸèƒ½é é¢
                document.querySelectorAll('.åŠŸèƒ½é é¢').forEach(page => {
                    page.classList.remove('é¡¯ç¤º');
                });
                
                // é¡¯ç¤ºç›®æ¨™åŠŸèƒ½é é¢
                const targetId = this.getAttribute('data-target');
                document.getElementById(targetId).classList.add('é¡¯ç¤º');
                
                // é‡ç½®é€²åº¦é¡¯ç¤º
                æ›´æ–°é€²åº¦é¡¯ç¤º('å·²åˆ‡æ›åˆ°' + this.textContent);
                document.getElementById('ä¸Šå‚³åœ–ç‰‡é è¦½').style.display = 'none';
            });
        });

        // é€šç”¨åŠŸèƒ½ï¼šæ›´æ–°é€²åº¦é¡¯ç¤º
        function æ›´æ–°é€²åº¦é¡¯ç¤º(è¨Šæ¯, åœ–ç‰‡URL = null) {
            const é€²åº¦é¡¯ç¤ºå€ = document.getElementById('é€²åº¦é¡¯ç¤ºå€');
            const é€²åº¦è¨Šæ¯ = document.getElementById('é€²åº¦è¨Šæ¯');
            const åœ–ç‰‡é è¦½ = document.getElementById('ä¸Šå‚³åœ–ç‰‡é è¦½');
            
            é€²åº¦è¨Šæ¯.textContent = è¨Šæ¯;
            
            if (åœ–ç‰‡URL) {
                åœ–ç‰‡é è¦½.src = åœ–ç‰‡URL;
                åœ–ç‰‡é è¦½.style.display = 'block';
            } else {
                åœ–ç‰‡é è¦½.style.display = 'none';
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çš„é€šç”¨å‡½æ•¸
        function é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯(è¨Šæ¯) {
            const éŒ¯èª¤å€å¡Š = document.createElement('div');
            éŒ¯èª¤å€å¡Š.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px;
                background: var(--éŒ¯èª¤è‰²);
                color: white;
                border-radius: 8px;
                z-index: 1000;
                max-width: 300px;
            `;
            éŒ¯èª¤å€å¡Š.textContent = è¨Šæ¯;
            document.body.appendChild(éŒ¯èª¤å€å¡Š);
            setTimeout(() => éŒ¯èª¤å€å¡Š.remove(), 5000);
            
            æ›´æ–°é€²åº¦é¡¯ç¤º('è™•ç†å¤±æ•—: ' + è¨Šæ¯);
        }

        // æª”æ¡ˆè½‰ Base64 çš„é€šç”¨å‡½æ•¸
        function è½‰æ›ç‚ºBase64(æª”æ¡ˆ) {
            return new Promise((resolve) => {
                const è®€å–å™¨ = new FileReader();
                è®€å–å™¨.onload = e => resolve(e.target.result);
                è®€å–å™¨.readAsDataURL(æª”æ¡ˆ);
            });
        }

        // å£“ç¸®åœ–ç‰‡çš„é€šç”¨å‡½æ•¸
        async function å£“ç¸®åœ–ç‰‡(æª”æ¡ˆ, é¸é …) {
            return new Promise((resolve) => {
                const åœ–ç‰‡ = new Image();
                åœ–ç‰‡.src = URL.createObjectURL(æª”æ¡ˆ);
                åœ–ç‰‡.onload = () => {
                    const ç•«å¸ƒ = document.createElement('canvas');
                    const ç•«ç­† = ç•«å¸ƒ.getContext('2d');
                    const æ¯”ä¾‹ = Math.min(é¸é ….maxWidth / åœ–ç‰‡.width, 1);
                    ç•«å¸ƒ.width = åœ–ç‰‡.width * æ¯”ä¾‹;
                    ç•«å¸ƒ.height = åœ–ç‰‡.height * æ¯”ä¾‹;
                    ç•«ç­†.drawImage(åœ–ç‰‡, 0, 0, ç•«å¸ƒ.width, ç•«å¸ƒ.height);
                    ç•«å¸ƒ.toBlob(blob => resolve(blob), 'image/jpeg', é¸é ….quality);
                };
            });
        }

        // å¾ Gemini å›æ‡‰ä¸­æå– JSON çš„é€šç”¨å‡½æ•¸
        function æå–JSON(rawText) {
            const jsonMatch = rawText.match(/``````/) || rawText.match(/{[\s\S]*}/);
            if (jsonMatch) return jsonMatch[1] || jsonMatch[0];
            throw new Error('ç„¡æ³•æå–æœ‰æ•ˆçš„ JSON å›æ‡‰');
        }

        // æ˜¯å¦ç‚ºiOSè£ç½®çš„é€šç”¨å‡½æ•¸
        function æ˜¯å¦ç‚ºiOSè£ç½®() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }

        // å…¬ç”¨çš„ API KEY
        const API_KEY = 'AIzaSyD3McoKeSkz7WovvznaKk9uWf_Q1CDGHVw';

        //========== åç‰‡è¾¨è­˜ç³»çµ± ==========
        let åç‰‡_è¯çµ¡äººåˆ—è¡¨ = [];

        const åç‰‡_æ¬„ä½æç¤º = {
            å§“å: "è«‹è¼¸å…¥å§“å",
            è·ç¨±: "è«‹è¼¸å…¥è·ç¨±",
            å…¬å¸: "è«‹è¼¸å…¥å…¬å¸åç¨±",
            é›»è©±: "è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼",
            ä¿¡ç®±: "è«‹è¼¸å…¥é›»å­éƒµä»¶",
            åœ°å€: "è«‹è¼¸å…¥åœ°å€",
            ç¶²ç«™: "è«‹è¼¸å…¥ç¶²ç«™ç¶²å€"
        };

        // åˆå§‹åŒ–æ‹–æ”¾åŠŸèƒ½
        const åç‰‡_æ‹–æ”¾å€ = document.getElementById('åç‰‡_æ‹–æ”¾å€');
        const åç‰‡_æª”æ¡ˆè¼¸å…¥ = document.getElementById('åç‰‡_æª”æ¡ˆè¼¸å…¥');
        const åç‰‡_é€²åº¦æ¢å®¹å™¨ = document.getElementById('åç‰‡_é€²åº¦æ¢å®¹å™¨');
        const åç‰‡_é€²åº¦æ¢ = document.getElementById('åç‰‡_é€²åº¦æ¢');

        åç‰‡_æ‹–æ”¾å€.addEventListener('click', () => åç‰‡_æª”æ¡ˆè¼¸å…¥.click());
        
        åç‰‡_æª”æ¡ˆè¼¸å…¥.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                åç‰‡_è™•ç†åœ–ç‰‡ä¸Šå‚³(e.target.files[0]);
            }
        });
        
        åç‰‡_æ‹–æ”¾å€.addEventListener('dragover', (e) => {
            e.preventDefault();
            åç‰‡_æ‹–æ”¾å€.style.backgroundColor = 'rgba(255, 196, 0, 0.1)';
        });

        åç‰‡_æ‹–æ”¾å€.addEventListener('dragleave', () => {
            åç‰‡_æ‹–æ”¾å€.style.backgroundColor = 'rgba(255, 196, 0, 0.05)';
        });

        åç‰‡_æ‹–æ”¾å€.addEventListener('drop', async (e) => {
            e.preventDefault();
            åç‰‡_æ‹–æ”¾å€.style.backgroundColor = 'rgba(255, 196, 0, 0.05)';
            const æª”æ¡ˆ = e.dataTransfer.files[0];
            if (æª”æ¡ˆ) åç‰‡_è™•ç†åœ–ç‰‡ä¸Šå‚³(æª”æ¡ˆ);
        });

        // åœ–ç‰‡è™•ç†æµç¨‹ä¸¦ä½¿ç”¨ Gemini API
        async function åç‰‡_è™•ç†åœ–ç‰‡ä¸Šå‚³(æª”æ¡ˆ) {
            try {
                if (!['image/png', 'image/jpeg'].includes(æª”æ¡ˆ.type)) {
                    throw new Error('åƒ…æ”¯æ´ PNG/JPEG æ ¼å¼');
                }

                æ›´æ–°é€²åº¦é¡¯ç¤º('æ­£åœ¨è™•ç†åç‰‡åœ–ç‰‡...');
                åç‰‡_æ›´æ–°é€²åº¦(0);
                åç‰‡_é€²åº¦æ¢å®¹å™¨.style.display = 'block';
                åç‰‡_æ›´æ–°é€²åº¦(20);

                const å£“ç¸®å¾Œæª”æ¡ˆ = await å£“ç¸®åœ–ç‰‡(æª”æ¡ˆ, { maxWidth: 1024, quality: 0.7 });
                åç‰‡_æ›´æ–°é€²åº¦(50);
                const base64è³‡æ–™ = await è½‰æ›ç‚ºBase64(å£“ç¸®å¾Œæª”æ¡ˆ);
                åç‰‡_æ›´æ–°é€²åº¦(70);

                // é¡¯ç¤ºä¸Šå‚³çš„åœ–ç‰‡é è¦½
                æ›´æ–°é€²åº¦é¡¯ç¤º('æ­£åœ¨è¾¨è­˜åç‰‡...', base64è³‡æ–™);

                // ä½¿ç”¨ Gemini API è¾¨è­˜åç‰‡
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    text: 'è«‹è¾¨è­˜é€™å¼µåœ–ç‰‡ä¸­çš„åç‰‡è³‡è¨Šï¼Œä¸¦ä»¥ JSON æ ¼å¼è¿”å›ä»¥ä¸‹å­—æ®µï¼šnameï¼ˆå§“åï¼‰, titleï¼ˆè·ç¨±ï¼‰, companyï¼ˆå…¬å¸ï¼‰, phoneï¼ˆé›»è©±ï¼‰, emailï¼ˆä¿¡ç®±ï¼‰, addressï¼ˆåœ°å€ï¼‰, websiteï¼ˆç¶²ç«™ï¼‰ã€‚å¦‚æœæŸå­—æ®µç„¡æ³•è¾¨è­˜ï¼Œè«‹è¨­ç‚º "æœªçŸ¥"ã€‚'
                                },
                                {
                                    inlineData: {
                                        mimeType: æª”æ¡ˆ.type,
                                        data: base64è³‡æ–™.split(',')[1] // ç§»é™¤å‰ç¶´
                                    }
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Gemini API è«‹æ±‚å¤±æ•—: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonText = æå–JSON(rawText);
                const è¯çµ¡äººè³‡æ–™ = JSON.parse(jsonText);

                // è½‰æ›å­—æ®µåç¨±ä»¥åŒ¹é…ç¾æœ‰çµæ§‹
                const è½‰æ›å¾Œè³‡æ–™ = {
                    å§“å: è¯çµ¡äººè³‡æ–™.name || åç‰‡_æ¬„ä½æç¤º.å§“å,
                    è·ç¨±: è¯çµ¡äººè³‡æ–™.title || åç‰‡_æ¬„ä½æç¤º.è·ç¨±,
                    å…¬å¸: è¯çµ¡äººè³‡æ–™.company || åç‰‡_æ¬„ä½æç¤º.å…¬å¸,
                    é›»è©±: è¯çµ¡äººè³‡æ–™.phone || åç‰‡_æ¬„ä½æç¤º.é›»è©±,
                    ä¿¡ç®±: è¯çµ¡äººè³‡æ–™.email || åç‰‡_æ¬„ä½æç¤º.ä¿¡ç®±,
                    åœ°å€: è¯çµ¡äººè³‡æ–™.address || åç‰‡_æ¬„ä½æç¤º.åœ°å€,
                    ç¶²ç«™: è¯çµ¡äººè³‡æ–™.website || åç‰‡_æ¬„ä½æç¤º.ç¶²ç«™
                };

                åç‰‡_æ›´æ–°é€²åº¦(100);
                åç‰‡_è¯çµ¡äººåˆ—è¡¨ = [è½‰æ›å¾Œè³‡æ–™, ...åç‰‡_è¯çµ¡äººåˆ—è¡¨];
                åç‰‡_æ¸²æŸ“è¯çµ¡äºº();

                // æ›´æ–°é€²åº¦é¡¯ç¤º
                æ›´æ–°é€²åº¦é¡¯ç¤º('åç‰‡è¾¨è­˜å®Œæˆï¼', base64è³‡æ–™);

                setTimeout(() => {
                    åç‰‡_é€²åº¦æ¢å®¹å™¨.style.display = 'none';
                    åç‰‡_æ›´æ–°é€²åº¦(0);
                }, 500);
            } catch (éŒ¯èª¤) {
                é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯(`è™•ç†å¤±æ•—: ${éŒ¯èª¤.message}`);
                åç‰‡_é€²åº¦æ¢å®¹å™¨.style.display = 'none';
                åç‰‡_æ›´æ–°é€²åº¦(0);
            }
        }

        // åŒ¯å‡ºåˆ°é€šè¨ŠéŒ„
        function åç‰‡_åŒ¯å‡ºè¯çµ¡äºº(ç´¢å¼•) {
            const è¯çµ¡äºº = åç‰‡_è¯çµ¡äººåˆ—è¡¨[ç´¢å¼•];
            const vCardè³‡æ–™ = åç‰‡_ç”¢ç”ŸvCard(è¯çµ¡äºº);
            
            const æª”æ¡ˆ = new Blob([vCardè³‡æ–™], { type: 'text/vcard' });
            const æª”æ¡ˆç¶²å€ = URL.createObjectURL(æª”æ¡ˆ);

            æ›´æ–°é€²åº¦é¡¯ç¤º(`æ­£åœ¨åŒ¯å‡º ${è¯çµ¡äºº.å§“å} çš„è¯çµ¡è³‡è¨Š...`);

            if (æ˜¯å¦ç‚ºiOSè£ç½®()) {
                window.location.href = æª”æ¡ˆç¶²å€;
            } else {
                const é€£çµ = document.createElement('a');
                é€£çµ.href = æª”æ¡ˆç¶²å€;
                é€£çµ.download = `${è¯çµ¡äºº.å§“å}.vcf`;
                é€£çµ.click();
                URL.revokeObjectURL(æª”æ¡ˆç¶²å€);
            }

            setTimeout(() => {
                æ›´æ–°é€²åº¦é¡¯ç¤º(`å·²åŒ¯å‡º ${è¯çµ¡äºº.å§“å} çš„è¯çµ¡è³‡è¨Š`);
            }, 1000);
        }

        // ç”¢ç”ŸvCardæ ¼å¼
        function åç‰‡_ç”¢ç”ŸvCard(è¯çµ¡äºº) {
            let vCard = `BEGIN:VCARD
VERSION:3.0
N:${è¯çµ¡äºº.å§“å};;;
FN:${è¯çµ¡äºº.å§“å}`;

            if (è¯çµ¡äºº.å…¬å¸ && è¯çµ¡äºº.å…¬å¸ !== åç‰‡_æ¬„ä½æç¤º.å…¬å¸ && è¯çµ¡äºº.å…¬å¸ !== "æœªçŸ¥") 
                vCard += `\nORG:${è¯çµ¡äºº.å…¬å¸}`;
            if (è¯çµ¡äºº.è·ç¨± && è¯çµ¡äºº.è·ç¨± !== åç‰‡_æ¬„ä½æç¤º.è·ç¨± && è¯çµ¡äºº.è·ç¨± !== "æœªçŸ¥") 
                vCard += `\nTITLE:${è¯çµ¡äºº.è·ç¨±}`;
            if (è¯çµ¡äºº.é›»è©± && è¯çµ¡äºº.é›»è©± !== åç‰‡_æ¬„ä½æç¤º.é›»è©± && è¯çµ¡äºº.é›»è©± !== "æœªçŸ¥") 
                vCard += `\nTEL;TYPE=CELL:${è¯çµ¡äºº.é›»è©±}`;
            if (è¯çµ¡äºº.ä¿¡ç®± && è¯çµ¡äºº.ä¿¡ç®± !== åç‰‡_æ¬„ä½æç¤º.ä¿¡ç®± && è¯çµ¡äºº.ä¿¡ç®± !== "æœªçŸ¥") 
                vCard += `\nEMAIL:${è¯çµ¡äºº.ä¿¡ç®±}`;
            if (è¯çµ¡äºº.åœ°å€ && è¯çµ¡äºº.åœ°å€ !== åç‰‡_æ¬„ä½æç¤º.åœ°å€ && è¯çµ¡äºº.åœ°å€ !== "æœªçŸ¥") 
                vCard += `\nADR:;;${è¯çµ¡äºº.åœ°å€}`;
            if (è¯çµ¡äºº.ç¶²ç«™ && è¯çµ¡äºº.ç¶²ç«™ !== åç‰‡_æ¬„ä½æç¤º.ç¶²ç«™ && è¯çµ¡äºº.ç¶²ç«™ !== "æœªçŸ¥") 
                vCard += `\nURL:${è¯çµ¡äºº.ç¶²ç«™}`;

            vCard += `\nEND:VCARD`;
            return vCard;
        }

        // é›™æ“Šç·¨è¼¯åŠŸèƒ½
        function åç‰‡_å•Ÿç”¨ç·¨è¼¯åŠŸèƒ½() {
            document.querySelectorAll('#åç‰‡_è¯çµ¡äººæ¸…å–® .è³‡æ–™æ¬„ä½').forEach(æ¬„ä½ => {
                æ¬„ä½.ondblclick = function() {
                    const ç´¢å¼• = this.closest('.è¯çµ¡äººé …ç›®').dataset.ç´¢å¼•;
                    const æ¬„ä½åç¨± = this.dataset.æ¬„ä½;
                    const å€¼å®¹å™¨ = this.querySelector('.å€¼å…§å®¹');
                    let ç•¶å‰å€¼ = åç‰‡_è¯çµ¡äººåˆ—è¡¨[ç´¢å¼•][æ¬„ä½åç¨±];
                    if (Object.values(åç‰‡_æ¬„ä½æç¤º).includes(ç•¶å‰å€¼) || ç•¶å‰å€¼ === "æœªçŸ¥") ç•¶å‰å€¼ = "";
                    
                    const è¼¸å…¥æ¡† = åç‰‡_å»ºç«‹ç·¨è¼¯è¼¸å…¥æ¡†(ç•¶å‰å€¼, æ¬„ä½åç¨±);
                    è¼¸å…¥æ¡†.onblur = () => åç‰‡_æ›´æ–°è¯çµ¡äººæ¬„ä½(ç´¢å¼•, æ¬„ä½åç¨±, è¼¸å…¥æ¡†.value);
                    
                    å€¼å®¹å™¨.innerHTML = '';
                    å€¼å®¹å™¨.appendChild(è¼¸å…¥æ¡†);
                    è¼¸å…¥æ¡†.focus();

                    æ›´æ–°é€²åº¦é¡¯ç¤º(`æ­£åœ¨ç·¨è¼¯ ${åç‰‡_è¯çµ¡äººåˆ—è¡¨[ç´¢å¼•].å§“å} çš„ ${æ¬„ä½åç¨±}`);
                };
            });
        }

        // æ¸²æŸ“è¯çµ¡äººåˆ—è¡¨
        function åç‰‡_æ¸²æŸ“è¯çµ¡äºº() {
            const å®¹å™¨ = document.getElementById('åç‰‡_è¯çµ¡äººæ¸…å–®');
            å®¹å™¨.innerHTML = åç‰‡_è¯çµ¡äººåˆ—è¡¨.map((è¯çµ¡äºº, ç´¢å¼•) => `
                <div class="è¯çµ¡äººé …ç›®" data-ç´¢å¼•="${ç´¢å¼•}">
                    <div class="è¯çµ¡äººå…§å®¹">
                        ${åç‰‡_ç”¢ç”Ÿæ¬„ä½HTML(è¯çµ¡äºº, 'å§“å', 'ğŸ‘¤')}
                        ${åç‰‡_ç”¢ç”Ÿæ¬„ä½HTML(è¯çµ¡äºº, 'è·ç¨±', 'ğŸ’¼')}
                        ${åç‰‡_ç”¢ç”Ÿæ¬„ä½HTML(è¯çµ¡äºº, 'å…¬å¸', 'ğŸ¢')}
                        ${åç‰‡_ç”¢ç”Ÿæ¬„ä½HTML(è¯çµ¡äºº, 'é›»è©±', 'ğŸ“±')}
                        ${åç‰‡_ç”¢ç”Ÿæ¬„ä½HTML(è¯çµ¡äºº, 'ä¿¡ç®±', 'ğŸ“§')}
                        ${åç‰‡_ç”¢ç”Ÿæ¬„ä½HTML(è¯çµ¡äºº, 'åœ°å€', 'ğŸ“')}
                        ${åç‰‡_ç”¢ç”Ÿæ¬„ä½HTML(è¯çµ¡äºº, 'ç¶²ç«™', 'ğŸŒ')}
                    </div>
                    <button class="ä¸»è¦æŒ‰éˆ•" onclick="åç‰‡_åŒ¯å‡ºè¯çµ¡äºº(${ç´¢å¼•})">
                        åŠ å…¥é€šè¨ŠéŒ„
                    </button>
                </div>
            `).join('');

            åç‰‡_å•Ÿç”¨ç·¨è¼¯åŠŸèƒ½();
        }

        // ç”¢ç”Ÿæ¬„ä½HTML
        function åç‰‡_ç”¢ç”Ÿæ¬„ä½HTML(è¯çµ¡äºº, æ¬„ä½, åœ–ç¤º) {
            const å€¼ = è¯çµ¡äºº[æ¬„ä½] || åç‰‡_æ¬„ä½æç¤º[æ¬„ä½];
            const æ˜¯æç¤º = !è¯çµ¡äºº[æ¬„ä½] || å€¼ === 'æœªçŸ¥' || å€¼ === åç‰‡_æ¬„ä½æç¤º[æ¬„ä½];
            return `
                <div class="è³‡æ–™æ¬„ä½" data-æ¬„ä½="${æ¬„ä½}">
                    <div class="åœ–ç¤ºå€">${åœ–ç¤º}</div>
                    <div class="å€¼å…§å®¹${æ˜¯æç¤º ? ' æç¤ºæ–‡å­—' : ''}">${å€¼}</div>
                </div>
            `;
        }

        // åç‰‡ç³»çµ±å·¥å…·å‡½å¼
        function åç‰‡_æ›´æ–°é€²åº¦(ç™¾åˆ†æ¯”) {
            åç‰‡_é€²åº¦æ¢.style.width = `${ç™¾åˆ†æ¯”}%`;
        }

        function åç‰‡_å»ºç«‹ç·¨è¼¯è¼¸å…¥æ¡†(å€¼, æ¬„ä½) {
            const è¼¸å…¥æ¡† = document.createElement('input');
            è¼¸å…¥æ¡†.className = 'ç·¨è¼¯è¼¸å…¥æ¡†';
            è¼¸å…¥æ¡†.value = å€¼;
            
            if (æ¬„ä½ === 'é›»è©±') è¼¸å…¥æ¡†.pattern = "[0-9-]{10,}";
            if (æ¬„ä½ === 'ä¿¡ç®±') è¼¸å…¥æ¡†.type = 'email';
            if (æ¬„ä½ === 'ç¶²ç«™') è¼¸å…¥æ¡†.placeholder = "https://";

            return è¼¸å…¥æ¡†;
        }

        function åç‰‡_æ›´æ–°è¯çµ¡äººæ¬„ä½(ç´¢å¼•, æ¬„ä½, å€¼) {
            åç‰‡_è¯çµ¡äººåˆ—è¡¨[ç´¢å¼•][æ¬„ä½] = å€¼ || åç‰‡_æ¬„ä½æç¤º[æ¬„ä½];
            åç‰‡_æ¸²æŸ“è¯çµ¡äºº();

            æ›´æ–°é€²åº¦é¡¯ç¤º(`å·²æ›´æ–° ${åç‰‡_è¯çµ¡äººåˆ—è¡¨[ç´¢å¼•].å§“å} çš„ ${æ¬„ä½}`);
        }

        function åç‰‡_æ–°å¢è¯çµ¡äºº() {
            åç‰‡_è¯çµ¡äººåˆ—è¡¨.unshift({
                å§“å: åç‰‡_æ¬„ä½æç¤º.å§“å,
                è·ç¨±: åç‰‡_æ¬„ä½æç¤º.è·ç¨±,
                å…¬å¸: åç‰‡_æ¬„ä½æç¤º.å…¬å¸,
                é›»è©±: åç‰‡_æ¬„ä½æç¤º.é›»è©±,
                ä¿¡ç®±: åç‰‡_æ¬„ä½æç¤º.ä¿¡ç®±,
                åœ°å€: åç‰‡_æ¬„ä½æç¤º.åœ°å€,
                ç¶²ç«™: åç‰‡_æ¬„ä½æç¤º.ç¶²ç«™
            });
            åç‰‡_æ¸²æŸ“è¯çµ¡äºº();

            æ›´æ–°é€²åº¦é¡¯ç¤º('å·²æ–°å¢ç©ºç™½è¯çµ¡äºº');
        }

        //========== è¡Œç¨‹ç®¡ç†ç³»çµ± ==========
        let è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨ = [];
        let è¡Œç¨‹_æ˜¯å¦ç·¨è¼¯ä¸­ = false;

        // åˆå§‹åŒ–æ‹–æ”¾åŠŸèƒ½
        const è¡Œç¨‹_æ‹–æ”¾å€ = document.getElementById('è¡Œç¨‹_æ‹–æ”¾å€');
        const è¡Œç¨‹_æª”æ¡ˆè¼¸å…¥ = document.getElementById('è¡Œç¨‹_æª”æ¡ˆè¼¸å…¥');
        const è¡Œç¨‹_é€²åº¦æ¢ = document.getElementById('è¡Œç¨‹_é€²åº¦æ¢');

        è¡Œç¨‹_æ‹–æ”¾å€.addEventListener('click', () => è¡Œç¨‹_æª”æ¡ˆè¼¸å…¥.click());
        
        è¡Œç¨‹_æ‹–æ”¾å€.addEventListener('dragover', (e) => {
            e.preventDefault();
            è¡Œç¨‹_æ‹–æ”¾å€.style.backgroundColor = 'rgba(255, 196, 0, 0.1)';
        });

        è¡Œç¨‹_æ‹–æ”¾å€.addEventListener('dragleave', () => {
            è¡Œç¨‹_æ‹–æ”¾å€.style.backgroundColor = 'rgba(255, 196, 0, 0.05)';
        });

        è¡Œç¨‹_æ‹–æ”¾å€.addEventListener('drop', async (e) => {
            e.preventDefault();
            è¡Œç¨‹_æ‹–æ”¾å€.style.backgroundColor = 'rgba(255, 196, 0, 0.05)';
            const æª”æ¡ˆ = e.dataTransfer.files[0];
            if (æª”æ¡ˆ) è¡Œç¨‹_è™•ç†åœ–ç‰‡ä¸Šå‚³(æª”æ¡ˆ);
        });

        è¡Œç¨‹_æª”æ¡ˆè¼¸å…¥.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                è¡Œç¨‹_è™•ç†åœ–ç‰‡ä¸Šå‚³(e.target.files[0]);
                e.target.value = ''; // é‡ç½®æª”æ¡ˆè¼¸å…¥
            }
        });

        // è¡Œç¨‹åœ–ç‰‡è™•ç†å‡½å¼ - ä¸²æ¥ Gemini API
        async function è¡Œç¨‹_è™•ç†åœ–ç‰‡ä¸Šå‚³(æª”æ¡ˆ) {
            try {
                if (!['image/png', 'image/jpeg'].includes(æª”æ¡ˆ.type)) {
                    throw new Error('åƒ…æ”¯æ´PNG/JPEGæ ¼å¼');
                }

                æ›´æ–°é€²åº¦é¡¯ç¤º('æ­£åœ¨è™•ç†è¡Œç¨‹åœ–ç‰‡...');
                è¡Œç¨‹_æ›´æ–°é€²åº¦(20);

                const base64Image = await è½‰æ›ç‚ºBase64(æª”æ¡ˆ);
                è¡Œç¨‹_æ›´æ–°é€²åº¦(40);

                // é¡¯ç¤ºä¸Šå‚³çš„åœ–ç‰‡é è¦½
                æ›´æ–°é€²åº¦é¡¯ç¤º('æ­£åœ¨è¾¨è­˜è¡Œç¨‹è³‡è¨Š...', base64Image);
                è¡Œç¨‹_æ›´æ–°é€²åº¦(60);

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    text: 'è«‹è¾¨è­˜é€™å¼µåœ–ç‰‡ä¸­çš„è¡Œç¨‹è³‡è¨Šï¼Œä¸¦ä»¥ JSON æ ¼å¼è¿”å›ä»¥ä¸‹å­—æ®µï¼štitleï¼ˆæ´»å‹•åç¨±ï¼‰, dateï¼ˆæ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DDï¼‰, startTimeï¼ˆé–‹å§‹æ™‚é–“ï¼ŒHH:MMï¼‰, endTimeï¼ˆçµæŸæ™‚é–“ï¼ŒHH:MMï¼‰, locationï¼ˆåœ°é»ï¼‰, costï¼ˆè²»ç”¨ï¼‰, notesï¼ˆå‚™è¨»ï¼‰ã€‚å¦‚æœæŸå­—æ®µç„¡æ³•è¾¨è­˜ï¼Œè«‹è¨­ç‚º "æœªçŸ¥"ã€‚'
                                },
                                {
                                    inlineData: {
                                        mimeType: æª”æ¡ˆ.type,
                                        data: base64Image.split(',')[1]
                                    }
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('API è«‹æ±‚å¤±æ•—');
                }

                è¡Œç¨‹_æ›´æ–°é€²åº¦(80);

                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonText = æå–JSON(rawText);
                const recognizedEvent = JSON.parse(jsonText);

                è¡Œç¨‹_æ›´æ–°é€²åº¦(100);
                è¡Œç¨‹_é¡¯ç¤ºè¾¨è­˜çµæœ(recognizedEvent, 'åœ–ç‰‡è¾¨è­˜çµæœ');
                æ›´æ–°é€²åº¦é¡¯ç¤º('è¡Œç¨‹è³‡è¨Šè¾¨è­˜å®Œæˆï¼', base64Image);

                setTimeout(() => {
                    è¡Œç¨‹_æ›´æ–°é€²åº¦(0);
                }, 1000);
            } catch (error) {
                é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯(`åœ–ç‰‡è™•ç†å¤±æ•—: ${error.message}`);
                è¡Œç¨‹_æ›´æ–°é€²åº¦(0);
            }
        }

        // è¡Œç¨‹æ–‡å­—è™•ç†å‡½å¼ - ä¸²æ¥ Gemini API
        async function è¡Œç¨‹_è™•ç†æ–‡å­—è¼¸å…¥() {
            const textInput = document.getElementById('è¡Œç¨‹_æ–‡å­—è¼¸å…¥').value.trim();
            if (!textInput) {
                é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯('è«‹è¼¸å…¥æ–‡å­—');
                return;
            }

            try {
                æ›´æ–°é€²åº¦é¡¯ç¤º('æ­£åœ¨è™•ç†æ–‡å­—è¼¸å…¥...');
                è¡Œç¨‹_æ›´æ–°é€²åº¦(20);

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    text: `è«‹å¾ä»¥ä¸‹æ–‡å­—ä¸­æå–è¡Œç¨‹è³‡è¨Šï¼Œä¸¦ä»¥ JSON æ ¼å¼è¿”å›ä»¥ä¸‹å­—æ®µï¼štitleï¼ˆæ´»å‹•åç¨±ï¼‰, dateï¼ˆæ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DDï¼‰, startTimeï¼ˆé–‹å§‹æ™‚é–“ï¼ŒHH:MMï¼‰, endTimeï¼ˆçµæŸæ™‚é–“ï¼ŒHH:MMï¼‰, locationï¼ˆåœ°é»ï¼‰, costï¼ˆè²»ç”¨ï¼‰, notesï¼ˆå‚™è¨»ï¼‰ã€‚å¦‚æœæŸå­—æ®µç„¡æ³•è¾¨è­˜ï¼Œè«‹è¨­ç‚º "æœªçŸ¥"ã€‚æ–‡å­—å…§å®¹ï¼š${textInput}`
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('API è«‹æ±‚å¤±æ•—');
                }

                è¡Œç¨‹_æ›´æ–°é€²åº¦(60);

                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonText = æå–JSON(rawText);
                const recognizedEvent = JSON.parse(jsonText);

                è¡Œç¨‹_æ›´æ–°é€²åº¦(100);
                è¡Œç¨‹_é¡¯ç¤ºè¾¨è­˜çµæœ(recognizedEvent, 'æ–‡å­—è¾¨è­˜çµæœ');
                æ›´æ–°é€²åº¦é¡¯ç¤º('æ–‡å­—è¼¸å…¥è¾¨è­˜å®Œæˆï¼');

                setTimeout(() => {
                    è¡Œç¨‹_æ›´æ–°é€²åº¦(0);
                }, 1000);
            } catch (error) {
                é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯(`æ–‡å­—è™•ç†å¤±æ•—: ${error.message}`);
                è¡Œç¨‹_æ›´æ–°é€²åº¦(0);
            }
        }

        // é¡¯ç¤ºè¾¨è­˜çµæœçš„å‡½æ•¸
        function è¡Œç¨‹_é¡¯ç¤ºè¾¨è­˜çµæœ(recognizedEvent, sourceLabel) {
            const container = document.getElementById('è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨');
            const tempDiv = document.createElement('div');
            tempDiv.className = 'äº‹ä»¶é …ç›®';
            tempDiv.innerHTML = `
                <div class="äº‹ä»¶å…§å®¹">
                    <div class="äº‹ä»¶æ¨™é¡Œ" data-field="title">
                        <div class="æ¬„ä½åœ–ç¤º">ğŸ“Œ</div>
                        <div>${recognizedEvent.title} (${sourceLabel})</div>
                    </div>
                    <div class="äº‹ä»¶æ¬„ä½" data-field="time">
                        <div class="æ¬„ä½åœ–ç¤º">ğŸ•’</div>
                        <div>${recognizedEvent.date} ${recognizedEvent.startTime} - ${recognizedEvent.endTime}</div>
                    </div>
                    <div class="äº‹ä»¶æ¬„ä½" data-field="location">
                        <div class="æ¬„ä½åœ–ç¤º">ğŸ“</div>
                        <div>${recognizedEvent.location}</div>
                    </div>
                    <div class="äº‹ä»¶æ¬„ä½" data-field="cost">
                        <div class="æ¬„ä½åœ–ç¤º">ğŸ’°</div>
                        <div>${recognizedEvent.cost}</div>
                    </div>
                    <div class="äº‹ä»¶æ¬„ä½" data-field="notes">
                        <div class="æ¬„ä½åœ–ç¤º">ğŸ“</div>
                        <div>${recognizedEvent.notes}</div>
                    </div>
                </div>
                <div>
                    <button class="ä¸»è¦æŒ‰éˆ•" onclick='è¡Œç¨‹_ç¢ºèªäº‹ä»¶(${JSON.stringify(recognizedEvent)})'>
                        ç¢ºèªæ–°å¢
                    </button>
                    <button class="æ¬¡è¦æŒ‰éˆ•" onclick="this.parentElement.parentElement.remove()">
                        å–æ¶ˆ
                    </button>
                </div>
            `;
            container.insertBefore(tempDiv, container.firstChild);
        }

        // ç¢ºèªæ–°å¢äº‹ä»¶
        function è¡Œç¨‹_ç¢ºèªäº‹ä»¶(eventData) {
            è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨.push(eventData);
            è¡Œç¨‹_æ¸²æŸ“äº‹ä»¶();
            æ›´æ–°é€²åº¦é¡¯ç¤º(`å·²ç¢ºèªæ–°å¢ ${eventData.title} è¡Œç¨‹`);
        }

        // æ™‚é–“è¼¸å…¥å…ƒä»¶
        function è¡Œç¨‹_å‰µå»ºæ™‚é–“ç·¨è¼¯å™¨(dateStr, startTime, endTime) {
            const [year, month, day] = dateStr.split('-');
            const [startHour, startMinute] = startTime.split(':');
            const [endHour, endMinute] = endTime.split(':');

            return `
                <div class="æ™‚é–“è¼¸å…¥çµ„">
                    <input class="æ™‚é–“è¼¸å…¥" type="number" value="${year}" placeholder="å¹´" min="2000" max="2100">
                    <input class="æ™‚é–“è¼¸å…¥" type="number" value="${month}" placeholder="æœˆ" min="1" max="12">
                    <input class="æ™‚é–“è¼¸å…¥" type="number" value="${day}" placeholder="æ—¥" min="1" max="31">
                    <span>|</span>
                    <input class="æ™‚é–“è¼¸å…¥" type="number" value="${startHour}" placeholder="æ™‚" min="0" max="23">
                    <input class="æ™‚é–“è¼¸å…¥" type="number" value="${startMinute}" placeholder="åˆ†" min="0" max="59">
                    <span>-</span>
                    <input class="æ™‚é–“è¼¸å…¥" type="number" value="${endHour}" placeholder="æ™‚" min="0" max="23">
                    <input class="æ™‚é–“è¼¸å…¥" type="number" value="${endMinute}" placeholder="åˆ†" min="0" max="59">
                </div>
            `;
        }

        // é©—è­‰æ—¥æœŸæ™‚é–“
        function è¡Œç¨‹_é©—è­‰æ—¥æœŸæ™‚é–“(year, month, day, startHour, startMinute, endHour, endMinute) {
            const date = new Date(year, month - 1, day, startHour, startMinute);
            const end = new Date(year, month - 1, day, endHour, endMinute);
            return date.getDate() === parseInt(day) && end > date;
        }

        // å¼·åŒ–è¡Œç¨‹ç·¨è¼¯åŠŸèƒ½
        function è¡Œç¨‹_å•Ÿç”¨ç·¨è¼¯åŠŸèƒ½() {
            document.querySelectorAll('#è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨ .äº‹ä»¶æ¨™é¡Œ, #è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨ .äº‹ä»¶æ¬„ä½').forEach(element => {
                element.ondblclick = function() {
                    if (è¡Œç¨‹_æ˜¯å¦ç·¨è¼¯ä¸­) return; // é¿å…å¤šé‡ç·¨è¼¯
                    const index = this.closest('.äº‹ä»¶é …ç›®').dataset.index;
                    if (index === undefined) return; // é¿å…è‡¨æ™‚äº‹ä»¶è§¸ç™¼ç·¨è¼¯
                    const field = this.dataset.field;
                    const event = è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨[index];

                    è¡Œç¨‹_æ˜¯å¦ç·¨è¼¯ä¸­ = true;
                    const editorContainer = document.createElement('div');
                    
                    if (field === 'time') {
                        editorContainer.innerHTML = è¡Œç¨‹_å‰µå»ºæ™‚é–“ç·¨è¼¯å™¨(
                            event.date, 
                            event.startTime, 
                            event.endTime
                        );

                        const inputs = editorContainer.querySelectorAll('input');
                        inputs.forEach(input => input.addEventListener('blur', () => {
                            const values = Array.from(inputs).map(i => i.value.padStart(2, '0'));
                            const [year, month, day, startHour, startMinute, endHour, endMinute] = values;
                            if (è¡Œç¨‹_é©—è­‰æ—¥æœŸæ™‚é–“(year, month, day, startHour, startMinute, endHour, endMinute)) {
                                event.date = `${year}-${month}-${day}`;
                                event.startTime = `${startHour}:${startMinute}`;
                                event.endTime = `${endHour}:${endMinute}`;
                                è¡Œç¨‹_æ¸²æŸ“äº‹ä»¶();
                                æ›´æ–°é€²åº¦é¡¯ç¤º(`å·²æ›´æ–° ${event.title} çš„æ™‚é–“è³‡è¨Š`);
                            } else {
                                é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯('ç„¡æ•ˆçš„æ—¥æœŸæˆ–æ™‚é–“');
                                è¡Œç¨‹_æ¸²æŸ“äº‹ä»¶();
                            }
                            è¡Œç¨‹_æ˜¯å¦ç·¨è¼¯ä¸­ = false;
                        }));
                    } else {
                        const input = document.createElement('input');
                        input.value = event[field];
                        input.style.width = '100%';
                        input.addEventListener('blur', () => {
                            event[field] = input.value;
                            è¡Œç¨‹_æ¸²æŸ“äº‹ä»¶();
                            è¡Œç¨‹_æ˜¯å¦ç·¨è¼¯ä¸­ = false;
                            æ›´æ–°é€²åº¦é¡¯ç¤º(`å·²æ›´æ–° ${event.title} çš„ ${field}`);
                        });
                        editorContainer.appendChild(input);
                    }

                    this.innerHTML = '';
                    this.appendChild(editorContainer);
                    editorContainer.querySelector('input')?.focus();
                    
                    æ›´æ–°é€²åº¦é¡¯ç¤º(`æ­£åœ¨ç·¨è¼¯ ${event.title} çš„ ${field}`);
                };
            });
        }

        // æ¸²æŸ“äº‹ä»¶åˆ—è¡¨
        function è¡Œç¨‹_æ¸²æŸ“äº‹ä»¶() {
            const container = document.getElementById('è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨');
            container.innerHTML = è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨.map((event, index) => `
                <div class="äº‹ä»¶é …ç›®" data-index="${index}">
                    <div class="äº‹ä»¶å…§å®¹">
                        <div class="äº‹ä»¶æ¨™é¡Œ" data-field="title">
                            <div class="æ¬„ä½åœ–ç¤º">ğŸ“Œ</div>
                            <div>${event.title}</div>
                        </div>
                        <div class="äº‹ä»¶æ¬„ä½" data-field="time">
                            <div class="æ¬„ä½åœ–ç¤º">ğŸ•’</div>
                            <div>${event.date} ${event.startTime} - ${event.endTime}</div>
                        </div>
                        <div class="äº‹ä»¶æ¬„ä½" data-field="location">
                            <div class="æ¬„ä½åœ–ç¤º">ğŸ“</div>
                            <div>${event.location}</div>
                        </div>
                        <div class="äº‹ä»¶æ¬„ä½" data-field="cost">
                            <div class="æ¬„ä½åœ–ç¤º">ğŸ’°</div>
                            <div>${event.cost}</div>
                        </div>
                        <div class="äº‹ä»¶æ¬„ä½" data-field="notes">
                            <div class="æ¬„ä½åœ–ç¤º">ğŸ“</div>
                            <div>${event.notes}</div>
                        </div>
                    </div>
                    <button class="ä¸»è¦æŒ‰éˆ•" onclick="è¡Œç¨‹_åŒ¯å‡ºåˆ°Googleæ—¥æ›†(${index})">
                        æ–°å¢åˆ°Googleæ—¥æ›†
                    </button>
                </div>
            `).join('');

            è¡Œç¨‹_å•Ÿç”¨ç·¨è¼¯åŠŸèƒ½();
        }

        // æ–°å¢ç©ºç™½äº‹ä»¶
        function è¡Œç¨‹_æ–°å¢äº‹ä»¶() {
            const today = new Date().toISOString().split('T')[0];
            è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨.push({
                title: "æ–°è¡Œç¨‹",
                date: today,
                startTime: "09:00",
                endTime: "10:00",
                location: "æœªæŒ‡å®š",
                cost: "æœªçŸ¥",
                notes: "è«‹è¼¸å…¥è©³ç´°è³‡è¨Š"
            });
            è¡Œç¨‹_æ¸²æŸ“äº‹ä»¶();
            æ›´æ–°é€²åº¦é¡¯ç¤º('å·²æ–°å¢ç©ºç™½è¡Œç¨‹');
        }

        // åŒ¯å‡ºåˆ°Googleæ—¥æ›†
        function è¡Œç¨‹_åŒ¯å‡ºåˆ°Googleæ—¥æ›†(index) {
            const event = è¡Œç¨‹_äº‹ä»¶åˆ—è¡¨[index];
            
            const [year, month, day] = event.date.split('-');
            const [startHour, startMinute] = event.startTime.split(':');
            const [endHour, endMinute] = event.endTime.split(':');
            
            const startDateTime = `${year}${month}${day}T${startHour}${startMinute}00`;
            const endDateTime = `${year}${month}${day}T${endHour}${endMinute}00`;

            const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE` +
                `&text=${encodeURIComponent(event.title)}` +
                `&dates=${startDateTime}/${endDateTime}` +
                `&location=${encodeURIComponent(event.location)}` +
                `&details=${encodeURIComponent(`è²»ç”¨: ${event.cost}\nå‚™è¨»: ${event.notes}`)}`;

            window.open(googleCalendarUrl, '_blank');
            æ›´æ–°é€²åº¦é¡¯ç¤º(`å·²åŒ¯å‡º ${event.title} åˆ° Google æ—¥æ›†`);
        }

        // æ›´æ–°è¡Œç¨‹é€²åº¦æ¢
        function è¡Œç¨‹_æ›´æ–°é€²åº¦(ç™¾åˆ†æ¯”) {
            è¡Œç¨‹_é€²åº¦æ¢.style.width = `${ç™¾åˆ†æ¯”}%`;
        }

        // åˆå§‹åŒ–å…©å€‹ç³»çµ±
        åç‰‡_æ–°å¢è¯çµ¡äºº();
        è¡Œç¨‹_æ–°å¢äº‹ä»¶();

        // åˆå§‹æ›´æ–°é€²åº¦é¡¯ç¤º
        æ›´æ–°é€²åº¦é¡¯ç¤º('ç³»çµ±å·²æº–å‚™å°±ç·’');
    </script>
</body>
</html>
