<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§è¾¦å…¬æ•´åˆç³»çµ±</title>
    <style>
        :root {
            --main: #FFC400;
            --main-light: #FFD740;
            --main-dark: #FFAB00;
            --error: #D32F2F;
            --font-size: 15px;
        }
        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
            font-size: var(--font-size);
            background: #FFF9E6;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 210px;
            background: #fff;
            border-right: 2px solid var(--main);
            min-height: 100vh;
            box-shadow: 2px 0 6px rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            padding-top: 24px;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 10;
        }
        .sidebar-btn {
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            padding: 18px 28px;
            font-size: 17px;
            color: #4D3900;
            cursor: pointer;
            border-left: 6px solid transparent;
            transition: background 0.2s, border-color 0.2s;
            font-weight: 500;
        }
        .sidebar-btn.active, .sidebar-btn:hover {
            background: rgba(255, 196, 0, 0.13);
            border-left: 6px solid var(--main-dark);
            color: #000;
        }
        .main-content {
            margin-left: 210px;
            width: calc(100vw - 210px);
            min-height: 100vh;
            background: #FFF9E6;
            padding: 0;
        }
        .progress-bar-wrap {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--main);
            transition: width 0.3s;
        }
        .top-status {
            background: #fff;
            padding: 18px 24px;
            border-bottom: 2px solid var(--main);
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .top-status img {
            max-height: 80px;
            border-radius: 6px;
            margin-left: 8px;
            display: none;
        }
        .page-wrap {
            max-width: 900px;
            margin: 36px auto 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.07);
            border: 2px solid var(--main);
            padding: 32px 24px 32px 24px;
        }
        .drop-zone, .text-input-zone {
            border: 3px dashed var(--main);
            background: rgba(255, 196, 0, 0.07);
            padding: 36px 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 24px;
            border-radius: 12px;
            transition: background 0.2s;
        }
        .drop-zone:hover, .text-input-zone:hover {
            background: rgba(255, 196, 0, 0.13);
        }
        .main-btn, .sec-btn {
            border: none;
            border-radius: 20px;
            padding: 9px 24px;
            font-size: 15px;
            margin: 4px 8px 4px 0;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .main-btn {
            background: var(--main);
            color: #4D3900;
            font-weight: bold;
        }
        .main-btn:hover {
            background: var(--main-dark);
            color: #fff;
        }
        .sec-btn {
            background: #fff;
            color: var(--main);
            border: 2px solid var(--main);
        }
        .sec-btn:hover {
            background: var(--main-light);
        }
        .contact-card, .event-item, .snippet-li {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            border-left: 5px solid var(--main);
            position: relative;
        }
        .contact-content, .event-content, .snippet-content {
            flex-grow: 1;
            margin-right: 18px;
        }
        .field-row, .event-field {
            margin: 7px 0;
            padding: 7px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .field-icon {
            min-width: 24px;
            text-align: center;
        }
        .field-edit {
            width: 100%;
            padding: 6px;
            font-size: inherit;
            border: 1px solid var(--main);
            border-radius: 4px;
        }
        .hint {
            color: #888;
            font-style: italic;
        }
        .snippet-li {
            align-items: center;
        }
        .snippet-content {
            word-break: break-all;
            white-space: pre-wrap;
        }
        .snippet-btns {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        @media screen and (max-width: 900px) {
            .main-content { width: 100vw; margin-left: 0; }
            .sidebar { position: static; width: 100vw; min-height: 0; flex-direction: row; border-right: none; border-bottom: 2px solid var(--main);}
            .sidebar-btn { width: 33.3vw; border-left: none; border-bottom: 6px solid transparent; border-radius: 0; text-align: center;}
            .sidebar-btn.active, .sidebar-btn:hover { border-bottom: 6px solid var(--main-dark); border-left: none; }
            .top-status { flex-direction: column; align-items: flex-start; gap: 8px;}
            .page-wrap { border-radius: 0; box-shadow: none; }
        }
        @media screen and (max-width: 600px) {
            .page-wrap { padding: 12px 3vw; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button class="sidebar-btn active" data-page="card">åç‰‡è¾¨è­˜</button>
        <button class="sidebar-btn" data-page="schedule">è¡Œç¨‹ç®¡ç†</button>
        <button class="sidebar-btn" data-page="clipboard">æ‡¶äººè¤‡è£½è²¼ä¸Š</button>
    </div>
    <div class="main-content">
        <!-- é€²åº¦/ç‹€æ…‹é¡¯ç¤º -->
        <div class="top-status">
            <span id="status-msg">æ­¡è¿ä½¿ç”¨æ™ºæ…§è¾¦å…¬æ•´åˆç³»çµ±</span>
            <img id="status-img" />
        </div>
        <!-- åç‰‡è¾¨è­˜ -->
        <div class="page-wrap" id="page-card">
            <h2 style="color:var(--main);margin-top:0;">æ™ºæ…§åç‰‡è¾¨è­˜</h2>
            <div class="drop-zone" id="card-drop">
                <p>æ‹–æ”¾åç‰‡åœ–æª”è‡³æ­¤æˆ–é»æ“Šä¸Šå‚³ (PNG/JPG)</p>
                <input type="file" id="card-file" hidden accept="image/png, image/jpeg">
                <div class="progress-bar-wrap"><div class="progress-bar" id="card-progress"></div></div>
            </div>
            <div id="card-list"></div>
            <button class="main-btn" onclick="cardAddContact()">+ æ–°å¢è¯çµ¡äºº</button>
        </div>
        <!-- è¡Œç¨‹ç®¡ç† -->
        <div class="page-wrap" id="page-schedule" style="display:none;">
            <h2 style="color:var(--main);margin-top:0;">æ™ºæ…§è¡Œç¨‹ç®¡ç†</h2>
            <div class="drop-zone" id="schedule-drop">
                <p>æ‹–æ”¾åœ–ç‰‡è‡³æ­¤æˆ–é»æ“Šä¸Šå‚³ (PNG/JPG)</p>
                <input type="file" id="schedule-file" hidden accept="image/png, image/jpeg">
                <div class="progress-bar-wrap"><div class="progress-bar" id="schedule-progress"></div></div>
            </div>
            <div class="text-input-zone">
                <p>è²¼ä¸Šæ–‡å­—ä»¥è¾¨è­˜è¡Œç¨‹è³‡è¨Š</p>
                <textarea id="schedule-text" placeholder="åœ¨æ­¤è²¼ä¸Šæ–‡å­—ï¼Œä¾‹å¦‚ï¼šæœƒè­° 2025-03-15 14:00-16:00 å°åŒ—101 è²»ç”¨500å…ƒ" style="width:100%;height:90px;"></textarea>
                <button class="main-btn" onclick="scheduleHandleText()">è¾¨è­˜æ–‡å­—</button>
            </div>
            <div id="schedule-list"></div>
            <button class="main-btn" onclick="scheduleAddEvent()">+ æ–°å¢è¡Œç¨‹</button>
        </div>
        <!-- æ‡¶äººè¤‡è£½è²¼ä¸Š -->
        <div class="page-wrap" id="page-clipboard" style="display:none;">
            <h2 style="color:var(--main);margin-top:0;">Kamaæ‡¶äººè¤‡è£½è²¼ä¸Š</h2>
            <div class="drop-zone" style="margin-bottom:20px;">
                <div id="clipboard-input-wrap" style="display:flex;gap:8px;">
                    <textarea id="clipboard-input" class="field-edit" placeholder="è¼¸å…¥è¦è¤‡è£½çš„æ–‡å­—" style="flex:1;min-height:60px;"></textarea>
                    <button class="main-btn" onclick="clipboardAdd()">æ–°å¢</button>
                </div>
            </div>
            <ul id="clipboard-list" style="list-style:none;padding:0;margin:0;"></ul>
            <div style="margin-top:24px;text-align:center;">
                <a href="https://docs.google.com/spreadsheets/d/1Rb3NJ1nsjCEn6OswNtOrRzuYiI4dN3Er8k5nR3iIrW8/edit?usp=sharing" target="_blank" style="color:var(--main-dark);text-decoration:underline;">Kamaæ‡¶äººç‰ˆè¤‡è£½è²¼ä¸ŠGoogle Sheets</a>
            </div>
        </div>
    </div>
    <script>
    // ====== å…¨åŸŸç‹€æ…‹/åˆ‡æ› ======
    function setStatus(msg, img) {
        document.getElementById('status-msg').textContent = msg;
        const imgel = document.getElementById('status-img');
        if (img) {
            imgel.src = img;
            imgel.style.display = 'inline-block';
        } else {
            imgel.style.display = 'none';
        }
    }
    document.querySelectorAll('.sidebar-btn').forEach(btn => {
        btn.onclick = function() {
            document.querySelectorAll('.sidebar-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.page-wrap').forEach(p=>p.style.display='none');
            document.getElementById('page-'+btn.dataset.page).style.display = '';
            setStatus('ç›®å‰é€²åº¦ï¼š' + btn.textContent);
        };
    });

    // ====== åç‰‡è¾¨è­˜ ======
    let cardContacts = [];
    const cardFieldHint = { å§“å:"è«‹è¼¸å…¥å§“å", è·ç¨±:"è«‹è¼¸å…¥è·ç¨±", å…¬å¸:"è«‹è¼¸å…¥å…¬å¸åç¨±", é›»è©±:"è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼", ä¿¡ç®±:"è«‹è¼¸å…¥é›»å­éƒµä»¶", åœ°å€:"è«‹è¼¸å…¥åœ°å€", ç¶²ç«™:"è«‹è¼¸å…¥ç¶²ç«™ç¶²å€" };
    const cardDrop = document.getElementById('card-drop');
    const cardFile = document.getElementById('card-file');
    const cardProgress = document.getElementById('card-progress');
    cardDrop.onclick = ()=>cardFile.click();
    cardDrop.ondragover = e=>{e.preventDefault();cardDrop.style.background="rgba(255,196,0,0.13)";};
    cardDrop.ondragleave = ()=>cardDrop.style.background="rgba(255,196,0,0.07)";
    cardDrop.ondrop = e=>{
        e.preventDefault();cardDrop.style.background="rgba(255,196,0,0.07)";
        if(e.dataTransfer.files[0]) cardHandleUpload(e.dataTransfer.files[0]);
    };
    cardFile.onchange = e=>{
        if(e.target.files[0]) cardHandleUpload(e.target.files[0]);
    };
    async function cardHandleUpload(file) {
        try {
            setStatus('åç‰‡åœ–ç‰‡ä¸Šå‚³ä¸­...');
            cardProgress.style.width='15%';
            if(!['image/png','image/jpeg'].includes(file.type)) throw new Error('åƒ…æ”¯æ´ PNG/JPG');
            const base64 = await fileToBase64(file);
            cardProgress.style.width='50%';
            setStatus('åç‰‡è¾¨è­˜ä¸­...', base64);
            const resp = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyD3McoKeSkz7WovvznaKk9uWf_Q1CDGHVw',{
                method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[
                    {text:'è«‹è¾¨è­˜é€™å¼µåœ–ç‰‡ä¸­çš„åç‰‡è³‡è¨Šï¼Œä¸¦ä»¥ JSON æ ¼å¼è¿”å›ä»¥ä¸‹å­—æ®µï¼šnameï¼ˆå§“åï¼‰, titleï¼ˆè·ç¨±ï¼‰, companyï¼ˆå…¬å¸ï¼‰, phoneï¼ˆé›»è©±ï¼‰, emailï¼ˆä¿¡ç®±ï¼‰, addressï¼ˆåœ°å€ï¼‰, websiteï¼ˆç¶²ç«™ï¼‰ã€‚å¦‚æœæŸå­—æ®µç„¡æ³•è¾¨è­˜ï¼Œè«‹è¨­ç‚º "æœªçŸ¥"ã€‚'},
                    {inlineData:{mimeType:file.type,data:base64.split(',')[1]}}
                ]}]})
            });
            cardProgress.style.width='85%';
            if(!resp.ok) throw new Error('APIå¤±æ•—');
            const data = await resp.json();
            const raw = data.candidates[0].content.parts[0].text;
            const json = extractJson(raw);
            const c = JSON.parse(json);
            const obj = {
                å§“å: c.name||cardFieldHint.å§“å,
                è·ç¨±: c.title||cardFieldHint.è·ç¨±,
                å…¬å¸: c.company||cardFieldHint.å…¬å¸,
                é›»è©±: c.phone||cardFieldHint.é›»è©±,
                ä¿¡ç®±: c.email||cardFieldHint.ä¿¡ç®±,
                åœ°å€: c.address||cardFieldHint.åœ°å€,
                ç¶²ç«™: c.website||cardFieldHint.ç¶²ç«™
            };
            cardContacts.unshift(obj);
            cardRender();
            setStatus('åç‰‡è¾¨è­˜å®Œæˆ', base64);
            cardProgress.style.width='100%';
            setTimeout(()=>cardProgress.style.width='0%', 800);
        } catch(e) {
            showError('åç‰‡è¾¨è­˜å¤±æ•—ï¼š'+e.message);
            cardProgress.style.width='0%';
        }
    }
    function cardRender() {
        const wrap = document.getElementById('card-list');
        wrap.innerHTML = cardContacts.map((c,i)=>`
            <div class="contact-card" data-i="${i}">
                <div class="contact-content">
                    ${cardFieldHtml(c,'å§“å','ğŸ‘¤')}
                    ${cardFieldHtml(c,'è·ç¨±','ğŸ’¼')}
                    ${cardFieldHtml(c,'å…¬å¸','ğŸ¢')}
                    ${cardFieldHtml(c,'é›»è©±','ğŸ“±')}
                    ${cardFieldHtml(c,'ä¿¡ç®±','ğŸ“§')}
                    ${cardFieldHtml(c,'åœ°å€','ğŸ“')}
                    ${cardFieldHtml(c,'ç¶²ç«™','ğŸŒ')}
                </div>
                <button class="main-btn" onclick="cardExportContact(${i})">åŠ å…¥é€šè¨ŠéŒ„</button>
            </div>
        `).join('');
        cardEnableEdit();
    }
    function cardFieldHtml(obj, k, icon) {
        const v = obj[k]||cardFieldHint[k];
        const isHint = !obj[k]||v==='æœªçŸ¥';
        return `<div class="field-row${isHint?' hint':''}" data-field="${k}"><span class="field-icon">${icon}</span><span class="field-val">${v}</span></div>`;
    }
    function cardEnableEdit() {
        document.querySelectorAll('#card-list .field-row').forEach(row=>{
            row.ondblclick = function() {
                const idx = this.closest('.contact-card').dataset.i;
                const field = this.dataset.field;
                const valSpan = this.querySelector('.field-val');
                const nowVal = cardContacts[idx][field]==='æœªçŸ¥'||Object.values(cardFieldHint).includes(cardContacts[idx][field])?'':cardContacts[idx][field];
                const input = document.createElement('input');
                input.className = 'field-edit';
                input.value = nowVal;
                input.onblur = ()=>{cardContacts[idx][field]=input.value||cardFieldHint[field];cardRender();};
                valSpan.innerHTML = '';
                valSpan.appendChild(input);
                input.focus();
            };
        });
    }
    function cardExportContact(i) {
        const c = cardContacts[i];
        let vCard = `BEGIN:VCARD\nVERSION:3.0\nN:${c.å§“å};;;\nFN:${c.å§“å}`;
        if(c.å…¬å¸&&c.å…¬å¸!==cardFieldHint.å…¬å¸&&c.å…¬å¸!=='æœªçŸ¥')vCard+=`\nORG:${c.å…¬å¸}`;
        if(c.è·ç¨±&&c.è·ç¨±!==cardFieldHint.è·ç¨±&&c.è·ç¨±!=='æœªçŸ¥')vCard+=`\nTITLE:${c.è·ç¨±}`;
        if(c.é›»è©±&&c.é›»è©±!==cardFieldHint.é›»è©±&&c.é›»è©±!=='æœªçŸ¥')vCard+=`\nTEL;TYPE=CELL:${c.é›»è©±}`;
        if(c.ä¿¡ç®±&&c.ä¿¡ç®±!==cardFieldHint.ä¿¡ç®±&&c.ä¿¡ç®±!=='æœªçŸ¥')vCard+=`\nEMAIL:${c.ä¿¡ç®±}`;
        if(c.åœ°å€&&c.åœ°å€!==cardFieldHint.åœ°å€&&c.åœ°å€!=='æœªçŸ¥')vCard+=`\nADR:;;${c.åœ°å€}`;
        if(c.ç¶²ç«™&&c.ç¶²ç«™!==cardFieldHint.ç¶²ç«™&&c.ç¶²ç«™!=='æœªçŸ¥')vCard+=`\nURL:${c.ç¶²ç«™}`;
        vCard+=`\nEND:VCARD`;
        const blob = new Blob([vCard],{type:'text/vcard'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${c.å§“å}.vcf`;
        a.click();
        URL.revokeObjectURL(url);
        setStatus('å·²åŒ¯å‡º '+c.å§“å+' çš„è¯çµ¡è³‡è¨Š');
    }
    function cardAddContact() {
        cardContacts.unshift({...cardFieldHint});
        cardRender();
        setStatus('å·²æ–°å¢ç©ºç™½è¯çµ¡äºº');
    }
    // ====== è¡Œç¨‹ç®¡ç† ======
    let scheduleEvents = [];
    const scheduleDrop = document.getElementById('schedule-drop');
    const scheduleFile = document.getElementById('schedule-file');
    const scheduleProgress = document.getElementById('schedule-progress');
    scheduleDrop.onclick = ()=>scheduleFile.click();
    scheduleDrop.ondragover = e=>{e.preventDefault();scheduleDrop.style.background="rgba(255,196,0,0.13)";};
    scheduleDrop.ondragleave = ()=>scheduleDrop.style.background="rgba(255,196,0,0.07)";
    scheduleDrop.ondrop = e=>{
        e.preventDefault();scheduleDrop.style.background="rgba(255,196,0,0.07)";
        if(e.dataTransfer.files[0]) scheduleHandleImage(e.dataTransfer.files[0]);
    };
    scheduleFile.onchange = e=>{
        if(e.target.files[0]) scheduleHandleImage(e.target.files[0]);
    };
    async function scheduleHandleImage(file) {
        try {
            setStatus('è¡Œç¨‹åœ–ç‰‡ä¸Šå‚³ä¸­...');
            scheduleProgress.style.width='15%';
            if(!['image/png','image/jpeg'].includes(file.type)) throw new Error('åƒ…æ”¯æ´ PNG/JPG');
            const base64 = await fileToBase64(file);
            scheduleProgress.style.width='50%';
            setStatus('è¡Œç¨‹è¾¨è­˜ä¸­...', base64);
            const resp = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyD3McoKeSkz7WovvznaKk9uWf_Q1CDGHVw',{
                method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[
                    {text:'è«‹è¾¨è­˜é€™å¼µåœ–ç‰‡ä¸­çš„è¡Œç¨‹è³‡è¨Šï¼Œä¸¦ä»¥ JSON æ ¼å¼è¿”å›ä»¥ä¸‹å­—æ®µï¼štitleï¼ˆæ´»å‹•åç¨±ï¼‰, dateï¼ˆæ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DDï¼‰, startTimeï¼ˆé–‹å§‹æ™‚é–“ï¼ŒHH:MMï¼‰, endTimeï¼ˆçµæŸæ™‚é–“ï¼ŒHH:MMï¼‰, locationï¼ˆåœ°é»ï¼‰, costï¼ˆè²»ç”¨ï¼‰, notesï¼ˆå‚™è¨»ï¼‰ã€‚å¦‚æœæŸå­—æ®µç„¡æ³•è¾¨è­˜ï¼Œè«‹è¨­ç‚º "æœªçŸ¥"ã€‚'},
                    {inlineData:{mimeType:file.type,data:base64.split(',')[1]}}
                ]}]})
            });
            scheduleProgress.style.width='85%';
            if(!resp.ok) throw new Error('APIå¤±æ•—');
            const data = await resp.json();
            const raw = data.candidates[0].content.parts[0].text;
            const json = extractJson(raw);
            const e = JSON.parse(json);
            scheduleShowRecognized(e, 'åœ–ç‰‡è¾¨è­˜çµæœ');
            setStatus('è¡Œç¨‹è¾¨è­˜å®Œæˆ', base64);
            scheduleProgress.style.width='100%';
            setTimeout(()=>scheduleProgress.style.width='0%', 800);
        } catch(e) {
            showError('è¡Œç¨‹è¾¨è­˜å¤±æ•—ï¼š'+e.message);
            scheduleProgress.style.width='0%';
        }
    }
    function scheduleShowRecognized(e, label) {
        const wrap = document.getElementById('schedule-list');
        const tempDiv = document.createElement('div');
        tempDiv.className = 'event-item';
        tempDiv.innerHTML = `
            <div class="event-content">
                <div class="event-title" data-field="title"><span class="field-icon">ğŸ“Œ</span><span>${e.title} (${label})</span></div>
                <div class="event-field" data-field="time"><span class="field-icon">ğŸ•’</span><span>${e.date} ${e.startTime} - ${e.endTime}</span></div>
                <div class="event-field" data-field="location"><span class="field-icon">ğŸ“</span><span>${e.location}</span></div>
                <div class="event-field" data-field="cost"><span class="field-icon">ğŸ’°</span><span>${e.cost}</span></div>
                <div class="event-field" data-field="notes"><span class="field-icon">ğŸ“</span><span>${e.notes}</span></div>
            </div>
            <div>
                <button class="main-btn" onclick='scheduleConfirmEvent(${JSON.stringify(e)})'>ç¢ºèªæ–°å¢</button>
                <button class="sec-btn" onclick="this.parentElement.parentElement.remove()">å–æ¶ˆ</button>
            </div>
        `;
        wrap.insertBefore(tempDiv, wrap.firstChild);
    }
    function scheduleConfirmEvent(e) {
        scheduleEvents.push(e);
        scheduleRender();
        setStatus('å·²ç¢ºèªæ–°å¢ '+e.title+' è¡Œç¨‹');
    }
    function scheduleRender() {
        const wrap = document.getElementById('schedule-list');
        wrap.innerHTML = scheduleEvents.map((e,i)=>`
            <div class="event-item" data-i="${i}">
                <div class="event-content">
                    <div class="event-title" data-field="title"><span class="field-icon">ğŸ“Œ</span><span>${e.title}</span></div>
                    <div class="event-field" data-field="time"><span class="field-icon">ğŸ•’</span><span>${e.date} ${e.startTime} - ${e.endTime}</span></div>
                    <div class="event-field" data-field="location"><span class="field-icon">ğŸ“</span><span>${e.location}</span></div>
                    <div class="event-field" data-field="cost"><span class="field-icon">ğŸ’°</span><span>${e.cost}</span></div>
                    <div class="event-field" data-field="notes"><span class="field-icon">ğŸ“</span><span>${e.notes}</span></div>
                </div>
                <button class="main-btn" onclick="scheduleExportCalendar(${i})">æ–°å¢åˆ°Googleæ—¥æ›†</button>
            </div>
        `).join('');
        scheduleEnableEdit();
    }
    function scheduleEnableEdit() {
        document.querySelectorAll('#schedule-list .event-title, #schedule-list .event-field').forEach(el=>{
            el.ondblclick = function() {
                const idx = this.closest('.event-item').dataset.i;
                if(idx===undefined) return;
                const field = this.dataset.field;
                const e = scheduleEvents[idx];
                if(field==='time') {
                    const [y,m,d]=e.date.split('-'), [sh,sm]=e.startTime.split(':'), [eh,em]=e.endTime.split(':');
                    const html = `
                        <div style="display:flex;gap:5px;align-items:center;">
                            <input class="field-edit" type="number" value="${y}" min="2000" max="2100" style="width:60px;">
                            <input class="field-edit" type="number" value="${m}" min="1" max="12" style="width:40px;">
                            <input class="field-edit" type="number" value="${d}" min="1" max="31" style="width:40px;">
                            <span>|</span>
                            <input class="field-edit" type="number" value="${sh}" min="0" max="23" style="width:40px;">
                            <input class="field-edit" type="number" value="${sm}" min="0" max="59" style="width:40px;">
                            <span>-</span>
                            <input class="field-edit" type="number" value="${eh}" min="0" max="23" style="width:40px;">
                            <input class="field-edit" type="number" value="${em}" min="0" max="59" style="width:40px;">
                        </div>`;
                    this.innerHTML = html;
                    const inputs = this.querySelectorAll('input');
                    inputs.forEach(input=>input.onblur=()=>{
                        const [yy,mm,dd,shh,smm,ehh,emm]=Array.from(inputs).map(i=>i.value.padStart(2,'0'));
                        e.date=`${yy}-${mm}-${dd}`;e.startTime=`${shh}:${smm}`;e.endTime=`${ehh}:${emm}`;
                        scheduleRender();
                    });
                    inputs[0].focus();
                } else {
                    const valSpan = this.querySelector('span:last-child');
                    const input = document.createElement('input');
                    input.className = 'field-edit';
                    input.value = e[field];
                    input.onblur = ()=>{e[field]=input.value;scheduleRender();};
                    valSpan.innerHTML = '';
                    valSpan.appendChild(input);
                    input.focus();
                }
            };
        });
    }
    function scheduleAddEvent() {
        const today = new Date().toISOString().split('T')[0];
        scheduleEvents.push({
            title:"æ–°è¡Œç¨‹", date:today, startTime:"09:00", endTime:"10:00",
            location:"æœªæŒ‡å®š", cost:"æœªçŸ¥", notes:"è«‹è¼¸å…¥è©³ç´°è³‡è¨Š"
        });
        scheduleRender();
        setStatus('å·²æ–°å¢ç©ºç™½è¡Œç¨‹');
    }
    function scheduleExportCalendar(i) {
        const e = scheduleEvents[i];
        const [y,m,d]=e.date.split('-'), [sh,sm]=e.startTime.split(':'), [eh,em]=e.endTime.split(':');
        const start = `${y}${m}${d}T${sh}${sm}00`, end = `${y}${m}${d}T${eh}${em}00`;
        const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(e.title)}&dates=${start}/${end}&location=${encodeURIComponent(e.location)}&details=${encodeURIComponent('è²»ç”¨: '+e.cost+'\nå‚™è¨»: '+e.notes)}`;
        window.open(url,'_blank');
        setStatus('å·²åŒ¯å‡º '+e.title+' åˆ° Google æ—¥æ›†');
    }
    async function scheduleHandleText() {
        const text = document.getElementById('schedule-text').value.trim();
        if(!text) return showError('è«‹è¼¸å…¥æ–‡å­—');
        try {
            setStatus('æ–‡å­—è¾¨è­˜ä¸­...');
            const resp = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyD3McoKeSkz7WovvznaKk9uWf_Q1CDGHVw',{
                method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[
                    {text:`è«‹å¾ä»¥ä¸‹æ–‡å­—ä¸­æå–è¡Œç¨‹è³‡è¨Šï¼Œä¸¦ä»¥ JSON æ ¼å¼è¿”å›ä»¥ä¸‹å­—æ®µï¼štitleï¼ˆæ´»å‹•åç¨±ï¼‰, dateï¼ˆæ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DDï¼‰, startTimeï¼ˆé–‹å§‹æ™‚é–“ï¼ŒHH:MMï¼‰, endTimeï¼ˆçµæŸæ™‚é–“ï¼ŒHH:MMï¼‰, locationï¼ˆåœ°é»ï¼‰, costï¼ˆè²»ç”¨ï¼‰, notesï¼ˆå‚™è¨»ï¼‰ã€‚å¦‚æœæŸå­—æ®µç„¡æ³•è¾¨è­˜ï¼Œè«‹è¨­ç‚º "æœªçŸ¥"ã€‚æ–‡å­—å…§å®¹ï¼š${text}`}
                ]}]})
            });
            if(!resp.ok) throw new Error('APIå¤±æ•—');
            const data = await resp.json();
            const raw = data.candidates[0].content.parts[0].text;
            const json = extractJson(raw);
            const e = JSON.parse(json);
            scheduleShowRecognized(e, 'æ–‡å­—è¾¨è­˜çµæœ');
            setStatus('æ–‡å­—è¾¨è­˜å®Œæˆ');
        } catch(e) {
            showError('æ–‡å­—è¾¨è­˜å¤±æ•—ï¼š'+e.message);
        }
    }
    // ====== æ‡¶äººè¤‡è£½è²¼ä¸Š ======
    let clipboardSnippets = [];
    function clipboardLoad() {
        const saved = localStorage.getItem('snippets');
        if(saved) clipboardSnippets = JSON.parse(saved);
    }
    function clipboardSave() {
        localStorage.setItem('snippets', JSON.stringify(clipboardSnippets));
    }
    function clipboardAdd() {
        const val = document.getElementById('clipboard-input').value.trim();
        if(!val) return;
        clipboardSnippets.unshift(val);
        clipboardSave();
        clipboardRender();
        document.getElementById('clipboard-input').value = '';
        setStatus('å·²æ–°å¢ç‰‡æ®µ');
    }
    function clipboardRender() {
        const ul = document.getElementById('clipboard-list');
        ul.innerHTML = clipboardSnippets.map((s,i)=>`
            <li class="snippet-li" draggable="true" data-i="${i}">
                <div class="snippet-content" ondblclick="clipboardEdit(${i},this)">${s}</div>
                <div class="snippet-btns">
                    <button class="sec-btn" onclick="clipboardCopy(${i})">è¤‡è£½</button>
                    <button class="sec-btn" onclick="clipboardDelete(${i})">åˆªé™¤</button>
                </div>
            </li>
        `).join('');
        clipboardInitDrag();
    }
    function clipboardEdit(i, el) {
        const input = document.createElement('textarea');
        input.className = 'field-edit';
        input.value = clipboardSnippets[i];
        input.style.minHeight = '60px';
        input.onblur = ()=>{clipboardSnippets[i]=input.value;clipboardSave();clipboardRender();};
        el.innerHTML = '';
        el.appendChild(input);
        input.focus();
    }
    function clipboardCopy(i) {
        navigator.clipboard.writeText(clipboardSnippets[i]);
        setStatus('å·²è¤‡è£½å…§å®¹');
    }
    function clipboardDelete(i) {
        clipboardSnippets.splice(i,1);
        clipboardSave();
        clipboardRender();
        setStatus('å·²åˆªé™¤ç‰‡æ®µ');
    }
    function clipboardInitDrag() {
        let draggedIdx = null;
        document.querySelectorAll('.snippet-li').forEach(li=>{
            li.ondragstart = e=>{draggedIdx = +li.dataset.i;};
            li.ondragover = e=>{e.preventDefault();};
            li.ondrop = e=>{
                e.preventDefault();
                const targetIdx = +li.dataset.i;
                if(draggedIdx===null||draggedIdx===targetIdx) return;
                const [item] = clipboardSnippets.splice(draggedIdx,1);
                clipboardSnippets.splice(targetIdx,0,item);
                clipboardSave();
                clipboardRender();
            };
        });
    }
    // Google SheetsåŒæ­¥
    async function clipboardSyncSheet() {
        try {
            const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQG0ujQ9qJqa1V4T7uqxLHAAg1-u84Iw1bVm7dV5wZ-39L6kdssyLYyfmaUr6JTegonBRG7HABxJih3/pub?gid=0&single=true&output=csv';
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(sheetUrl)}`,
                `https://corsproxy.io/?${encodeURIComponent(sheetUrl)}`,
                `https://api.codetabs.com/v1/proxy?quest=${sheetUrl}`
            ];
            let text = '';
            for(const url of proxies) {
                try {
                    const resp = await fetch(url);
                    if(resp.ok) { text = await resp.text(); if(text.trim()) break; }
                } catch {}
            }
            if(!text) throw new Error('Google SheetsåŒæ­¥å¤±æ•—');
            const rows = text.split('\n').map(r=>r.trim()).filter(r=>r.length>0);
            const merged = [...clipboardSnippets];
            rows.reverse().forEach(item=>{
                if(!merged.includes(item)) merged.unshift(item);
            });
            clipboardSnippets = merged.slice(0,50);
            clipboardSave();
            clipboardRender();
        } catch(e) {
            clipboardRender();
        }
    }
    // ====== å·¥å…· ======
    function fileToBase64(file) {
        return new Promise((resolve, reject)=>{
            const reader = new FileReader();
            reader.onload = ()=>resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    function extractJson(raw) {
        const m = raw.match(/``````/);
        if(m) return m[1].trim();
        const m2 = raw.match(/{[\s\S]*}/);
        if(m2) return m2[0];
        throw new Error('ç„¡æ³•æå–æœ‰æ•ˆçš„ JSON å›æ‡‰');
    }
    function showError(msg) {
        setStatus('éŒ¯èª¤ï¼š'+msg);
        alert(msg);
    }
    // ====== åˆå§‹åŒ– ======
    // åç‰‡
    cardAddContact();
    // è¡Œç¨‹
    scheduleAddEvent();
    // å‰ªè²¼ç°¿
    clipboardLoad();
    clipboardSyncSheet();
    clipboardRender();
    setStatus('ç³»çµ±å·²æº–å‚™å°±ç·’');
    </script>
</body>
</html>
